<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>A Multi-Platform Video Downloader</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet" />
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Inter', sans-serif;
      background: linear-gradient(to right, #0f2027, #203a43, #2c5364);
      color: white;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 40px 16px;
    }
    /* Logo */
    .logo {
      display: flex;
      align-items: center;
      margin-bottom: 30px;
    }
    .logo-icon {
      width: 48px;
      height: 48px;
      position: relative;
      background: linear-gradient(135deg, #00C6FF, #0072FF);
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 15px rgba(0, 114, 255, 0.3);
      margin-right: 15px;
    }
    .logo-icon::before {
      content: '';
      position: absolute;
      width: 24px;
      height: 24px;
      background: white;
      clip-path: polygon(0 0, 50% 25%, 100% 0, 100% 100%, 50% 75%, 0 100%);
    }
    .logo-text {
      font-size: 2rem;
      font-weight: 800;
      background: linear-gradient(to right, #00C6FF, #0072FF);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -0.5px;
    }
    .subtitle {
      font-size: 1.1rem;
      color: #c0c0c0;
      margin-bottom: 30px;
      text-align: center;
    }
    /* Tabs */
    .tabs {
      display: flex;
      justify-content: center;
      margin-bottom: 20px;
      gap: 12px;
      flex-wrap: wrap;
    }
    .tab {
      padding: 10px 18px;
      border: none;
      border-radius: 8px;
      background: #1e2a38;
      color: #fff;
      cursor: pointer;
      font-weight: 600;
      transition: background 0.2s;
    }
    .tab.active {
      background: #007bff;
    }
    /* Form */
    form {
      display: flex;
      background: white;
      border-radius: 12px;
      overflow: hidden;
      max-width: 600px;
      width: 100%;
      margin: 0 auto;
      flex-direction: row;
    }
    .input-wrapper {
      position: relative;
      flex: 1;
      display: flex;
      align-items: center;
    }
    .paste-button {
      position: absolute;
      right: 10px;
      padding: 6px 12px;
      background: #f0f0f0;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      color: #333;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    input[type="text"] {
      width: 100%;
      padding: 16px;
      padding-right: 90px;
      font-size: 16px;
      border: none;
      outline: none;
    }
    button[type="submit"] {
      padding: 0 24px;
      background-color: #007bff;
      color: white;
      font-size: 16px;
      border: none;
      cursor: pointer;
      transition: background-color 0.2s;
    }
    button[type="submit"]:hover {
      background-color: #0056b3;
    }
    /* Loader */
    .loader {
      border: 4px solid rgba(255, 255, 255, 0.3);
      border-top: 4px solid #007bff;
      border-radius: 50%;
      width: 28px;
      height: 28px;
      animation: spin 1s linear infinite;
      margin-top: 20px;
      display: none;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    /* History */
    .history {
      margin-top: 30px;
      max-width: 600px;
      width: 100%;
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
    }
    .history-item {
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      padding: 6px 0;
      font-size: 0.9rem;
    }
    .history-item:last-child {
      border-bottom: none;
    }
    /* Cookie Upload Section */
    .cookie-section {
      max-width: 600px;
      width: 100%;
      background: rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 25px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .cookie-info h3 {
      margin: 0 0 8px 0;
      color: #00C6FF;
      font-size: 1.1rem;
    }
    .cookie-info p {
      margin: 0 0 15px 0;
      color: #c0c0c0;
      font-size: 0.9rem;
      line-height: 1.4;
    }
    .cookie-upload {
      display: flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    .cookie-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      background: #1e2a38;
      color: white;
      cursor: pointer;
      font-size: 0.9rem;
      transition: background 0.2s;
    }
    .cookie-btn:hover:not(:disabled) {
      background: #2a3a48;
    }
    .cookie-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .upload-btn {
      background: #007bff;
    }
    .upload-btn:hover:not(:disabled) {
      background: #0056b3;
    }
    .cookie-status {
      font-size: 0.85rem;
      margin-left: 10px;
    }
    .cookie-status.success {
      color: #28a745;
    }
    .cookie-timer {
      margin-top: 8px;
      padding: 8px 12px;
      background: rgba(255, 193, 7, 0.1);
      border: 1px solid rgba(255, 193, 7, 0.3);
      border-radius: 6px;
      font-size: 0.85rem;
      color: #ffc107;
      display: flex;
      align-items: center;
      gap: 6px;
      width: 100%;
    }
    .timer-icon {
      font-size: 1rem;
    }
    .cookie-timer.expired {
      background: rgba(220, 53, 69, 0.1);
      border-color: rgba(220, 53, 69, 0.3);
      color: #dc3545;
    }
    .cookie-status.error {
      color: #dc3545;
    }
    .cookie-status.info {
      color: #17a2b8;
    }
    /* Cookie Guide Styles */
    .cookie-guide {
      margin: 20px 0;
      padding: 15px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      border-left: 4px solid #00C6FF;
    }
    .cookie-guide h4 {
      margin: 0 0 15px 0;
      color: #00C6FF;
      font-size: 1rem;
    }
    .guide-steps {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .step {
      display: flex;
      align-items: flex-start;
      gap: 12px;
    }
    .step-number {
      background: #007bff;
      color: white;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.8rem;
      font-weight: bold;
      flex-shrink: 0;
      margin-top: 2px;
    }
    .step-content {
      flex: 1;
      font-size: 0.9rem;
      line-height: 1.4;
      color: #e0e0e0;
    }
    .step-content strong {
      color: #fff;
    }
    .extension-link {
      color: #00C6FF;
      text-decoration: none;
      border-bottom: 1px solid transparent;
      transition: border-color 0.2s;
    }
    .extension-link:hover {
      border-bottom-color: #00C6FF;
    }
    .step-content a {
      color: #00C6FF;
      text-decoration: none;
    }
    .step-content a:hover {
      text-decoration: underline;
    }
    
    /* Progress Bar Styles */
    .progress-container {
      display: none;
      margin: 20px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.1);
    }
    .progress-container.show {
      display: block;
    }
    .progress-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    .progress-title {
      font-size: 1rem;
      font-weight: 600;
      color: #fff;
    }
    .progress-percentage {
      font-size: 1.1rem;
      font-weight: bold;
      color: #00C6FF;
    }
    .progress-bar-container {
      width: 100%;
      height: 8px;
      background: rgba(255, 255, 255, 0.1);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #00C6FF, #0072FF);
      border-radius: 4px;
      transition: width 0.3s ease;
      width: 0%;
    }
    .progress-info {
      display: flex;
      justify-content: space-between;
      font-size: 0.85rem;
      color: #ccc;
    }
    .progress-filename {
      font-weight: 500;
      color: #fff;
      margin-bottom: 5px;
      word-break: break-all;
    }
    .progress-status {
      margin-top: 10px;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 0.9rem;
      text-align: center;
    }
    .progress-status.downloading {
      background: rgba(0, 198, 255, 0.1);
      color: #00C6FF;
      border: 1px solid rgba(0, 198, 255, 0.3);
    }
    .progress-status.completed {
      background: rgba(40, 167, 69, 0.1);
      color: #28a745;
      border: 1px solid rgba(40, 167, 69, 0.3);
    }
    .progress-status.error {
      background: rgba(220, 53, 69, 0.1);
      color: #dc3545;
      border: 1px solid rgba(220, 53, 69, 0.3);
    }
  </style>
</head>
<body>

  <div class="logo">
    <div class="logo-icon"></div>
    <div class="logo-text">VideoCatcher</div>
  </div>

  <p class="subtitle">Download videos from YouTube, TikTok, Instagram for free!</p>

  <!-- Cookie Upload Section -->
  <div class="cookie-section">
    <div class="cookie-info">
      <h3>🔑 Upload Your Cookies (YouTube & Instagram)</h3>
      <p><strong>YouTube & Instagram:</strong> Cookies are required to download videos from these platforms. This ensures you can access content based on your account permissions.</p>
      <p><strong>TikTok:</strong> No cookies needed! You can download directly without any setup.</p>
    </div>
    
    <!-- Cookie Guide -->
    <div class="cookie-guide">
      <h4>📋 How to Get Your Cookies File:</h4>
      <div class="guide-steps">
        <div class="step">
          <span class="step-number">1</span>
          <div class="step-content">
            <strong>Install Chrome Extension:</strong>
            <a href="https://chrome.google.com/webstore/detail/get-cookiestxt-locally/cclelndahbckbenkjhflpdbgdldlbecc" target="_blank" class="extension-link">Get cookies.txt LOCALLY</a>
          </div>
        </div>
        <div class="step">
          <span class="step-number">2</span>
          <div class="step-content">
            <strong>Login to YouTube:</strong> Go to <a href="https://youtube.com" target="_blank">youtube.com</a> and sign in to your account (only needed for YouTube downloads)
          </div>
        </div>
        <div class="step">
          <span class="step-number">3</span>
          <div class="step-content">
            <strong>Download Cookies:</strong> Click the extension icon and select "Export cookies for this tab"
          </div>
        </div>
        <div class="step">
          <span class="step-number">4</span>
          <div class="step-content">
            <strong>Upload Below:</strong> Choose the downloaded .txt file and upload it
          </div>
        </div>
      </div>
    </div>
    
    <div class="cookie-upload">
      <input type="file" id="cookieFile" accept=".txt" style="display: none;">
      <button type="button" class="cookie-btn" onclick="document.getElementById('cookieFile').click()">Choose Cookies File</button>
      <button type="button" class="cookie-btn upload-btn" onclick="uploadCookies()" disabled>Upload</button>
      <span id="cookieStatus" class="cookie-status"></span>
      <div id="cookieTimer" class="cookie-timer" style="display: none;">
        <span class="timer-icon">⏰</span>
        <span id="timerText">Cookies expire in: <span id="timeRemaining"></span></span>
      </div>
    </div>
  </div>

  <div class="tabs">
    <button class="tab active" onclick="setPlatform('youtube')">YouTube</button>
    <button class="tab" onclick="setPlatform('tiktok')">TikTok</button>
    <button class="tab" onclick="setPlatform('instagram')">Instagram</button>
  </div>

  <form id="downloadForm">
    <input type="hidden" name="platform" id="platform" value="youtube">
    <div class="input-wrapper">
      <input type="text" name="video_url" id="video_url" placeholder="Paste video URL here..." required>
      <button type="button" class="paste-button" onclick="pasteUrl()">Paste</button>
    </div>
    <button type="submit">Download</button>
  </form>

  <!-- Progress Bar Component -->
  <div class="progress-container" id="progressContainer">
    <div class="progress-header">
      <div class="progress-title">Downloading Video</div>
      <div class="progress-percentage" id="progressPercentage">0%</div>
    </div>
    <div class="progress-filename" id="progressFilename">Preparing download...</div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <div class="progress-info">
      <span id="progressDownloaded">0 MB</span>
      <span id="progressTotal">0 MB</span>
    </div>
    <div class="progress-status downloading" id="progressStatus">Initializing download...</div>
  </div>

  <div class="loader" id="loader"></div>

  <div class="history" id="history" style="display:none;">
    <h3>Download History</h3>
    <div id="history-list"></div>
  </div>

  <script>
    let historyList = [];
    let currentEventSource = null;

    // Client-side analytics tracking
    function trackPageView() {
      // Track page view on load
      fetch('/api/track', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          event: 'page_view',
          page: 'index',
          timestamp: new Date().toISOString()
        })
      }).catch(err => console.log('Analytics tracking failed:', err));
    }

    function trackUserInteraction(action, details = {}) {
      // Track user interactions
      fetch('/api/track', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          event: 'user_interaction',
          action: action,
          details: details,
          timestamp: new Date().toISOString()
        })
      }).catch(err => console.log('Analytics tracking failed:', err));
    }

    // Track page view when page loads
    document.addEventListener('DOMContentLoaded', function() {
      trackPageView();
    });

    // Progress tracking functions
    function formatBytes(bytes) {
      if (bytes === 0) return '0 MB';
      const k = 1024;
      const sizes = ['Bytes', 'KB', 'MB', 'GB'];
      const i = Math.floor(Math.log(bytes) / Math.log(k));
      return parseFloat((bytes / Math.pow(k, i)).toFixed(1)) + ' ' + sizes[i];
    }

    function showProgressBar() {
      const progressContainer = document.getElementById('progressContainer');
      const loader = document.getElementById('loader');
      progressContainer.classList.add('show');
      loader.style.display = 'none';
    }

    function hideProgressBar() {
      const progressContainer = document.getElementById('progressContainer');
      progressContainer.classList.remove('show');
    }

    function updateProgress(data) {
      const progressBar = document.getElementById('progressBar');
      const progressPercentage = document.getElementById('progressPercentage');
      const progressDownloaded = document.getElementById('progressDownloaded');
      const progressTotal = document.getElementById('progressTotal');
      const progressFilename = document.getElementById('progressFilename');
      const progressStatus = document.getElementById('progressStatus');

      if (data.filename) {
        progressFilename.textContent = data.filename;
      }

      if (data.progress !== undefined) {
        progressBar.style.width = data.progress + '%';
        progressPercentage.textContent = data.progress.toFixed(1) + '%';
      }

      if (data.downloaded !== undefined) {
        progressDownloaded.textContent = formatBytes(data.downloaded);
      }

      if (data.total_size !== undefined && data.total_size > 0) {
        progressTotal.textContent = formatBytes(data.total_size);
      }

      if (data.completed) {
        progressStatus.textContent = 'Download completed! Starting file download...';
        progressStatus.className = 'progress-status completed';
        progressBar.style.width = '100%';
        progressPercentage.textContent = '100%';
      } else if (data.error) {
        progressStatus.textContent = 'Error: ' + data.error;
        progressStatus.className = 'progress-status error';
      } else {
        progressStatus.textContent = 'Downloading...';
        progressStatus.className = 'progress-status downloading';
      }
    }

    function startProgressTracking(downloadId) {
      if (currentEventSource) {
        currentEventSource.close();
      }

      showProgressBar();
      
      currentEventSource = new EventSource(`/download_progress/${downloadId}`);
      
      currentEventSource.onmessage = function(event) {
        try {
          const data = JSON.parse(event.data);
          updateProgress(data);
          
          if (data.completed) {
            currentEventSource.close();
            currentEventSource = null;
            // Hide progress bar after a delay
            setTimeout(() => {
              hideProgressBar();
            }, 3000);
          } else if (data.error) {
            currentEventSource.close();
            currentEventSource = null;
            // Hide progress bar after a delay
            setTimeout(() => {
              hideProgressBar();
            }, 5000);
          }
        } catch (e) {
          console.error('Error parsing progress data:', e);
        }
      };
      
      currentEventSource.onerror = function(event) {
        console.error('EventSource error:', event);
        if (currentEventSource) {
          currentEventSource.close();
          currentEventSource = null;
        }
        updateProgress({ error: 'Connection lost. Please try again.' });
        setTimeout(() => {
          hideProgressBar();
        }, 5000);
      };
    }

    // Cookie upload functionality
    document.getElementById('cookieFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      const uploadBtn = document.querySelector('.upload-btn');
      const status = document.getElementById('cookieStatus');
      
      if (file) {
        if (file.name.toLowerCase().endsWith('.txt')) {
          uploadBtn.disabled = false;
          status.textContent = `Selected: ${file.name}`;
          status.className = 'cookie-status info';
        } else {
          uploadBtn.disabled = true;
          status.textContent = 'Please select a .txt file';
          status.className = 'cookie-status error';
        }
      } else {
        uploadBtn.disabled = true;
        status.textContent = '';
        status.className = 'cookie-status';
      }
    });

    async function uploadCookies() {
      const fileInput = document.getElementById('cookieFile');
      const file = fileInput.files[0];
      const status = document.getElementById('cookieStatus');
      const uploadBtn = document.querySelector('.upload-btn');
      
      if (!file) {
        status.textContent = 'Please select a file first';
        status.className = 'cookie-status error';
        return;
      }
      
      const formData = new FormData();
      formData.append('cookies', file);
      
      uploadBtn.disabled = true;
      status.textContent = 'Uploading...';
      status.className = 'cookie-status info';
      
      try {
        const response = await fetch('/upload_cookies', {
          method: 'POST',
          body: formData
        });
        
        const data = await response.json();
        
        if (data.success) {
           status.textContent = '✅ ' + data.message;
           status.className = 'cookie-status success';
           fileInput.value = ''; // Clear file input
           
           // Start cookie timer
           startCookieTimer();
           
           // Update download form to show ready state
           updateDownloadFormState(true);
         } else {
          status.textContent = '❌ ' + (data.error || 'Upload failed');
          status.className = 'cookie-status error';
          uploadBtn.disabled = false;
        }
      } catch (error) {
        status.textContent = '❌ Upload failed: ' + error.message;
        status.className = 'cookie-status error';
        uploadBtn.disabled = false;
      }
    }

     function updateDownloadFormState(cookiesUploaded) {
       const form = document.getElementById('downloadForm');
       const submitBtn = form.querySelector('button[type="submit"]');
       const platform = document.getElementById('platform').value;
       
       if (platform === 'youtube' || platform === 'instagram') {
         if (cookiesUploaded) {
           submitBtn.style.background = '#28a745';
           submitBtn.textContent = 'Download (Ready!)';
         } else {
           submitBtn.style.background = '#6c757d';
           submitBtn.textContent = 'Upload Cookies First';
         }
       } else {
         submitBtn.style.background = '#007bff';
         submitBtn.textContent = 'Download';
       }
     }

     function setPlatform(platform) {
        document.getElementById('platform').value = platform;
        document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
        event.target.classList.add('active');
        
        // Show/hide cookie section and guide based on platform
        const cookieSection = document.querySelector('.cookie-section');
        const cookieGuide = document.querySelector('.cookie-guide');
        if (platform === 'youtube' || platform === 'instagram') {
          cookieSection.style.display = 'block';
          if (cookieGuide) cookieGuide.style.display = 'block';
        } else {
          cookieSection.style.display = 'none';
          if (cookieGuide) cookieGuide.style.display = 'none';
        }
        
        // Update download button state based on platform and cookie status
        const cookieStatus = document.getElementById('cookieStatus');
        const cookiesUploaded = cookieStatus.classList.contains('success');
        updateDownloadFormState(cookiesUploaded);
      }

    async function pasteUrl() {
      try {
        const text = await navigator.clipboard.readText();
        document.getElementById('video_url').value = text;
      } catch (err) {
        console.error('Clipboard read failed:', err);
      }
    }

    document.getElementById('downloadForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      
      // Track download attempt
      const url = document.getElementById('video_url').value;
      const platform = document.getElementById('platform').value;
      trackUserInteraction('download_attempt', { platform: platform, url_domain: new URL(url).hostname });
      
      // Check if cookies are uploaded for YouTube downloads
      const cookieStatus = document.getElementById('cookieStatus');
      
      if (platform === 'youtube' && !cookieStatus.classList.contains('success')) {
        alert('⚠️ Please upload your cookies file first to download YouTube videos!');
        document.querySelector('.cookie-section').scrollIntoView({ behavior: 'smooth' });
        trackUserInteraction('download_blocked', { reason: 'missing_cookies', platform: platform });
        return;
      }
      
      const loader = document.getElementById('loader');
      loader.style.display = 'block';

      try {
        const res = await fetch('/download', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ url, platform })
        });

        loader.style.display = 'none';

        if (!res.ok) {
          // Try to get error message from response
          try {
            const errorData = await res.json();
            alert('Error: ' + (errorData.error || 'Download failed'));
          } catch {
            alert('Error: Download failed with status ' + res.status);
          }
          return;
        }

        // Parse the JSON response with download info
        const downloadData = await res.json();
        
        if (downloadData.success && downloadData.download_id) {
          // Track successful download
          trackUserInteraction('download_success', { 
            platform: platform, 
            filename: downloadData.filename,
            download_id: downloadData.download_id 
          });
          
          // Start progress tracking
          startProgressTracking(downloadData.download_id);
          
          // Add to history
          historyList.unshift({
            platform,
            title: downloadData.filename || 'Unknown Video',
            time: new Date().toLocaleTimeString()
          });
          updateHistory();
          
          // Start the actual download after a short delay
          setTimeout(() => {
            const a = document.createElement('a');
            a.href = downloadData.download_url;
            a.download = downloadData.filename || 'video';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
          }, 1000);
          
        } else {
          trackUserInteraction('download_error', { 
            platform: platform, 
            error: downloadData.error || 'Invalid response from server' 
          });
          alert('Error: ' + (downloadData.error || 'Invalid response from server'));
        }
        
      } catch (err) {
        loader.style.display = 'none';
        trackUserInteraction('download_error', { 
          platform: platform, 
          error: err.message 
        });
        alert('Request failed: ' + err.message);
      }
    });

    function updateHistory() {
      const historyDiv = document.getElementById('history');
      const listDiv = document.getElementById('history-list');
      historyDiv.style.display = 'block';
      listDiv.innerHTML = '';
      historyList.slice(0,5).forEach(item => {
        const div = document.createElement('div');
        div.className = 'history-item';
        div.innerHTML = `<span>[${item.platform}] ${item.title}</span><span>${item.time}</span>`;
        listDiv.appendChild(div);
      });
    }
    
    // Cookie timer functionality
    let cookieTimerInterval = null;
    const COOKIE_VALIDITY_MINUTES = 15;
    
    function startCookieTimer() {
      const timerDiv = document.getElementById('cookieTimer');
      const timeRemainingSpan = document.getElementById('timeRemaining');
      
      // Clear any existing timer
      if (cookieTimerInterval) {
        clearInterval(cookieTimerInterval);
      }
      
      // Show timer
      timerDiv.style.display = 'flex';
      timerDiv.classList.remove('expired');
      
      // Set expiration time (15 minutes from now)
      const expirationTime = new Date().getTime() + (COOKIE_VALIDITY_MINUTES * 60 * 1000);
      
      // Update timer every second
      cookieTimerInterval = setInterval(() => {
        const now = new Date().getTime();
        const timeLeft = expirationTime - now;
        
        if (timeLeft <= 0) {
          // Timer expired
          clearInterval(cookieTimerInterval);
          timeRemainingSpan.textContent = 'EXPIRED';
          timerDiv.classList.add('expired');
          
          // Update download form state
          updateDownloadFormState(false);
          
          // Update cookie status
          const status = document.getElementById('cookieStatus');
          status.textContent = '⚠️ Cookies expired. Please upload again.';
          status.className = 'cookie-status error';
        } else {
          // Calculate minutes and seconds
          const minutes = Math.floor(timeLeft / (1000 * 60));
          const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
          
          // Format time display
          const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          timeRemainingSpan.textContent = timeString;
          
          // Change color when less than 2 minutes remaining
          if (timeLeft <= 2 * 60 * 1000) {
            timerDiv.classList.add('expired');
          }
        }
      }, 1000);
    }
    
    function hideCookieTimer() {
      const timerDiv = document.getElementById('cookieTimer');
      timerDiv.style.display = 'none';
      if (cookieTimerInterval) {
        clearInterval(cookieTimerInterval);
        cookieTimerInterval = null;
      }
    }

    // Check cookie status on page load
    async function checkCookieStatus() {
      try {
        const response = await fetch('/cookie_status');
        const data = await response.json();
        
        if (data.valid && data.remaining_seconds > 0) {
          // Cookies are still valid, show status and start timer
          const status = document.getElementById('cookieStatus');
          status.textContent = '✅ ' + data.message;
          status.className = 'cookie-status success';
          
          // Start timer with remaining time
          startCookieTimerWithRemaining(data.remaining_seconds);
          updateDownloadFormState(true);
        } else {
          // Cookies expired or missing
          updateDownloadFormState(false);
        }
      } catch (error) {
        console.log('Could not check cookie status:', error);
        updateDownloadFormState(false);
      }
    }
    
    function startCookieTimerWithRemaining(remainingSeconds) {
      const timerDiv = document.getElementById('cookieTimer');
      const timeRemainingSpan = document.getElementById('timeRemaining');
      
      // Clear any existing timer
      if (cookieTimerInterval) {
        clearInterval(cookieTimerInterval);
      }
      
      // Show timer
      timerDiv.style.display = 'flex';
      timerDiv.classList.remove('expired');
      
      // Set expiration time based on remaining seconds
      const expirationTime = new Date().getTime() + (remainingSeconds * 1000);
      
      // Update timer every second
      cookieTimerInterval = setInterval(() => {
        const now = new Date().getTime();
        const timeLeft = expirationTime - now;
        
        if (timeLeft <= 0) {
          // Timer expired
          clearInterval(cookieTimerInterval);
          timeRemainingSpan.textContent = 'EXPIRED';
          timerDiv.classList.add('expired');
          
          // Update download form state
          updateDownloadFormState(false);
          
          // Update cookie status
          const status = document.getElementById('cookieStatus');
          status.textContent = '⚠️ Cookies expired. Please upload again.';
          status.className = 'cookie-status error';
        } else {
          // Calculate minutes and seconds
          const minutes = Math.floor(timeLeft / (1000 * 60));
          const seconds = Math.floor((timeLeft % (1000 * 60)) / 1000);
          
          // Format time display
          const timeString = `${minutes}:${seconds.toString().padStart(2, '0')}`;
          timeRemainingSpan.textContent = timeString;
          
          // Change color when less than 2 minutes remaining
          if (timeLeft <= 2 * 60 * 1000) {
            timerDiv.classList.add('expired');
          }
        }
      }, 1000);
    }

    // Initialize download form state on page load
    document.addEventListener('DOMContentLoaded', function() {
      checkCookieStatus();
    });
  </script>

</body>
</html>
